#!/usr/bin/env php
<?php declare(strict_types=1);

foreach ([$_composer_autoload_path ?? __DIR__ . '/../../../autoload.php', __DIR__ . '/../vendor/autoload.php'] as $file) {
    if (file_exists($file)) {
        require $file;
        break;
    }
}

$configPath = null;
$workingDirectory = null;
$resolutionDepth = null;

for ($i = 1; $i < count($argv); $i++) {
    if (str_starts_with($argv[$i], '--config=')) {
        $configPath = substr($argv[$i], strlen('--config='));

    } else if (str_starts_with($argv[$i], '--depth=')) {
        $resolutionDepth = (int) substr($argv[$i], strlen('--depth='));

    } else if ($workingDirectory === null) {
        $workingDirectory = $argv[$i];

    } else {
        echo PHP_EOL . 'Too many arguments.' . PHP_EOL . PHP_EOL;
        exit(1);
    }
}

if ($configPath === null) {
    echo PHP_EOL . 'Config file not specified.' . PHP_EOL . PHP_EOL;
    exit(1);
}

$workingDirectory ??= getcwd();

if (! $workingDirectory) {
    echo PHP_EOL . 'Working directory not specified.' . PHP_EOL . PHP_EOL;
    exit(1);
}

$config = new AutoDoc\Config(require $configPath);

$command = new AutoDoc\Commands\ProcessAutoDocDebugTags($config, $resolutionDepth);

$command($workingDirectory);
